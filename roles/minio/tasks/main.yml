---
- name: 'Add minio-operator chart repo'
  kubernetes.core.helm_repository:
    name: minio-operator
    repo_url: https://operator.min.io/
    force_update: true
- name: 'Deploy minio by helm chart'
  kubernetes.core.helm:
    name: operator
    chart_ref: minio-operator/operator
    namespace: minio-operator
    create_namespace: true
    force: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
- name: 'Deploy minio tenant'
  kubernetes.core.helm:
    name: tenant
    chart_ref: minio-operator/tenant
    namespace: tenant-ns
    create_namespace: true
    values: "{{ lookup('template', 'values.yaml') | from_yaml }}"
    force: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
- name: 'Update /etc/host'
  block:
    - pause:
        minutes: 1
    - shell:
        cmd: "kubectl get ing -n tenant-ns | grep -e myminio-console -e myminio | awk '{print $4, $3}'"
      register: temp_var
    - lineinfile:
        insertbefore: BOF
        path: /etc/hosts
        line: '{{ temp_var.stdout }}'
    - command:
        cmd: cat /etc/hosts
    - command:
        cmd: curl http://minio-console.com/console
#    # check if all pod is pending or not